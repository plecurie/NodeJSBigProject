image: node:latest

#services:
#  - elassandra:latest

stages:
  - test
  - build
  - deploy

cache:
  paths:
    - node_modules/

test_unit:
  stage: test
  before_script:
    - npm install
    - npm audit fix
  script:
    - npm run test

build:
  stage: build
  before_script:
    - npm install
    - npm audit fix
  script:
    - npm run build

deploy_prod:
  stage: deploy
  artifacts:
    paths:
      - build/
  only:
    - master
  script:
    - ssh-add <(echo "$STAGING_PRIVATE_KEY")
    - ssh -p22 root@vps808693.ovh.net "mkdir /var/www/_tmp"
    - scp -P22 -r build/* root@vps808693.ovh.net:/var/www/_tmp
    - ssh -p22 root@vps808693.ovh.net "mv /var/www/scala-api /var/www/_old && mv /var/www/_tmp /var/www/scala-api"
    - ssh -p22 root@vps808693.ovh.net "rm -rf /var/www/_old"
  after_script:
    - npm start