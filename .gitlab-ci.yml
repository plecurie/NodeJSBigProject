image: node:latest

#services:
#  - elassandra:latest

before_script:
  - npm install

stages:
  - test
  - build
  - quality
  - deploy

cache:
  paths:
    - node_modules/

test_unit:
  stage: test
  script:
    - npm run test

build:
  stage: build
  script:
    - npm run build
    
quality:
  stage: quality
  image: docker:stable
  allow_failure: true
  services:
    - docker:stable-dind
  script:
    - mkdir codequality-results
    - docker run
        --env CODECLIMATE_CODE="$PWD"
        --volume "$PWD":/code
        --volume /var/run/docker.sock:/var/run/docker.sock
        --volume /tmp/cc:/tmp/cc
        codeclimate/codeclimate analyze -f html > ./codequality-results/index.html
  artifacts:
    paths:
      - codequality-results/

deploy_prod:
  stage: deploy
  artifacts:
    paths:
      - build/
  only:
    - master
  script:
    - ssh-add <(echo "$STAGING_PRIVATE_KEY")
    - ssh -p22 root@vps808693.ovh.net "mkdir /var/www/_tmp"
    - scp -P22 -r build/* root@vps808693.ovh.net:/var/www/_tmp
    - ssh -p22 root@vps808693.ovh.net "mv /var/www/scala-api /var/www/_old && mv /var/www/_tmp /var/www/scala-api"
    - ssh -p22 root@vps808693.ovh.net "rm -rf /var/www/_old"
